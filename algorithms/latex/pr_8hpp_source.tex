\hypertarget{pr_8hpp_source}{}\doxysection{pr.\+hpp}
\label{pr_8hpp_source}\index{pr.hpp@{pr.hpp}}
\mbox{\hyperlink{pr_8hpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/*}}
\DoxyCodeLine{2 \textcolor{comment}{ * This file uses algorithm implementation from LAGraph, which is available under}}
\DoxyCodeLine{3 \textcolor{comment}{ * their custom license. For details, see https://github.com/GraphBLAS/LAGraph/blob/reorg/LICENSE}}
\DoxyCodeLine{4 \textcolor{comment}{ * */}}
\DoxyCodeLine{5 }
\DoxyCodeLine{16 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{17 }
\DoxyCodeLine{18 \textcolor{preprocessor}{\#define GrB\_Matrix lablas::Matrix<float>*}}
\DoxyCodeLine{19 \textcolor{preprocessor}{\#define GrB\_Vector lablas::Vector<float>*}}
\DoxyCodeLine{20 \textcolor{preprocessor}{\#define MASK\_NULL static\_cast<const lablas::Vector<float>*>(NULL)}}
\DoxyCodeLine{21 }
\DoxyCodeLine{23 }
\DoxyCodeLine{24 \textcolor{keyword}{namespace }\mbox{\hyperlink{namespacelablas}{lablas}} \{}
\DoxyCodeLine{26     \textcolor{keyword}{namespace }algorithm \{}
\DoxyCodeLine{27 }
\DoxyCodeLine{28 \}}
\DoxyCodeLine{29 \}}
\DoxyCodeLine{30 }
\DoxyCodeLine{32 }
\DoxyCodeLine{43 \textcolor{keywordtype}{void} \mbox{\hyperlink{pr_8hpp_aa759210773f764b3453c6967514c6a96}{LAGraph\_page\_rank\_sinks}} (GrB\_Vector centrality, \textcolor{comment}{// centrality(i): GAP-\/style pagerank of node i}}
\DoxyCodeLine{44         \textcolor{comment}{// inputs:}}
\DoxyCodeLine{45                               LAGraph\_Graph<float> *G,        \textcolor{comment}{// input graph}}
\DoxyCodeLine{46                               \textcolor{keywordtype}{int} *iters,                     \textcolor{comment}{// output: number of iterations taken}}
\DoxyCodeLine{47                               \textcolor{keywordtype}{int} itermax = 100,              \textcolor{comment}{// maximum number of iterations (typically 100)}}
\DoxyCodeLine{48                               \textcolor{keywordtype}{double} damping = 0.85,           \textcolor{comment}{// damping factor (typically 0.85)}}
\DoxyCodeLine{49                               \textcolor{keywordtype}{double} tol = 1e-\/4               \textcolor{comment}{// stopping tolerance (typically 1e-\/4) ;}}
\DoxyCodeLine{50 )}
\DoxyCodeLine{51 \{}
\DoxyCodeLine{52     GrB\_Matrix AT = G-\/>AT;}
\DoxyCodeLine{53     lablas::Vector<Index>* d\_out = G-\/>coldegree; \textcolor{comment}{// TODO row degree and transpose}}
\DoxyCodeLine{54     GrB\_Vector r = NULL, *d = NULL, *t = NULL, *w = NULL, *d1 = NULL ;}
\DoxyCodeLine{55     lablas::Descriptor desc;}
\DoxyCodeLine{56 }
\DoxyCodeLine{57     \textcolor{comment}{//-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{58     \textcolor{comment}{// initializations}}
\DoxyCodeLine{59     \textcolor{comment}{//-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{60 }
\DoxyCodeLine{61     GrB\_Index n ;}
\DoxyCodeLine{62     GrB\_TRY (GrB\_Matrix\_nrows (\&n, AT)) ;}
\DoxyCodeLine{63 }
\DoxyCodeLine{64     \textcolor{keyword}{const} \textcolor{keywordtype}{double} scaled\_damping = (1 -\/ damping) / n ;}
\DoxyCodeLine{65     \textcolor{keywordtype}{float} rdiff = 1 ;       \textcolor{comment}{// first iteration is always done}}
\DoxyCodeLine{66 }
\DoxyCodeLine{67     \textcolor{comment}{// r = 1 / n}}
\DoxyCodeLine{68     GrB\_TRY (GrB\_Vector\_new (\&t, GrB\_FP32, n)) ;}
\DoxyCodeLine{69     GrB\_TRY (GrB\_Vector\_new (\&r, GrB\_FP32, n)) ;}
\DoxyCodeLine{70     GrB\_TRY (GrB\_Vector\_new (\&w, GrB\_FP32, n)) ;}
\DoxyCodeLine{71     GrB\_TRY (GrB\_Vector\_new (\&d, GrB\_FP32, n)) ;}
\DoxyCodeLine{72     GrB\_TRY (GrB\_Vector\_new (\&d1, GrB\_FP32, n)) ;}
\DoxyCodeLine{73     t-\/>set\_name(\textcolor{stringliteral}{"{}t"{}});}
\DoxyCodeLine{74     r-\/>set\_name(\textcolor{stringliteral}{"{}r"{}});}
\DoxyCodeLine{75     w-\/>set\_name(\textcolor{stringliteral}{"{}w"{}});}
\DoxyCodeLine{76     d-\/>set\_name(\textcolor{stringliteral}{"{}d"{}});}
\DoxyCodeLine{77     d1-\/>set\_name(\textcolor{stringliteral}{"{}d1"{}});}
\DoxyCodeLine{78 }
\DoxyCodeLine{79     \textcolor{keywordtype}{double} init\_rank = 1.0/n;}
\DoxyCodeLine{80     GrB\_TRY (GrB\_assign (r, MASK\_NULL, NULL, init\_rank, GrB\_ALL, n, NULL)) ;}
\DoxyCodeLine{81 }
\DoxyCodeLine{82     \textcolor{comment}{// find all sinks, where sink(i) = true if node i has d\_out(i)=0, or with}}
\DoxyCodeLine{83     \textcolor{comment}{// d\_out(i) not present.  LAGraph\_Property\_RowDegree computes d\_out =}}
\DoxyCodeLine{84     \textcolor{comment}{// G-\/>rowdegree so that it has no explicit zeros, so a structural mask can}}
\DoxyCodeLine{85     \textcolor{comment}{// be used here.}}
\DoxyCodeLine{86     lablas::Vector<bool>* sink = NULL;}
\DoxyCodeLine{87     lablas::Vector<float>* rsink = NULL;}
\DoxyCodeLine{88     GrB\_Index nsinks, nvals ;}
\DoxyCodeLine{89     GrB\_TRY (GrB\_Vector\_nvals (\&nvals, d\_out)) ;}
\DoxyCodeLine{90     nsinks = n -\/ nvals ;}
\DoxyCodeLine{91     \textcolor{keywordflow}{if} (nsinks > 0)}
\DoxyCodeLine{92     \{}
\DoxyCodeLine{93         \textcolor{comment}{// sink<!struct(d\_out)> = true}}
\DoxyCodeLine{94         GrB\_TRY (GrB\_Vector\_new (\&sink, GrB\_BOOL, n)) ;}
\DoxyCodeLine{95         GrB\_TRY (GrB\_assign (sink, d\_out, NULL, (\textcolor{keywordtype}{bool})\textcolor{keyword}{true}, GrB\_ALL, n, GrB\_DESC\_SC)) ;}
\DoxyCodeLine{96         GrB\_TRY (GrB\_Vector\_new (\&rsink, GrB\_FP32, n));}
\DoxyCodeLine{97         sink-\/>set\_name(\textcolor{stringliteral}{"{}sink"{}});}
\DoxyCodeLine{98         rsink-\/>set\_name(\textcolor{stringliteral}{"{}rsink"{}});}
\DoxyCodeLine{99     \}}
\DoxyCodeLine{100 }
\DoxyCodeLine{101     \textcolor{comment}{// prescale with damping factor, so it isn't done each iteration}}
\DoxyCodeLine{102     \textcolor{comment}{// d = d\_out / damping ;}}
\DoxyCodeLine{103     GrB\_TRY (GrB\_apply (d, MASK\_NULL, NULL, GrB\_DIV\_FP32, d\_out, damping, \&desc)) ;}
\DoxyCodeLine{104 }
\DoxyCodeLine{105     \textcolor{comment}{// d1 = 1 / damping}}
\DoxyCodeLine{106     \textcolor{keywordtype}{float} dmin = 1.0 / damping ;}
\DoxyCodeLine{107     GrB\_TRY (GrB\_assign (d1, MASK\_NULL, NULL, dmin, GrB\_ALL, n, NULL)) ;}
\DoxyCodeLine{108 }
\DoxyCodeLine{109     \textcolor{comment}{// d = max (d1, d)}}
\DoxyCodeLine{110     GrB\_TRY (GrB\_eWiseAdd (d, MASK\_NULL, NULL, GrB\_MAX\_FP32, d1, d, NULL)) ;}
\DoxyCodeLine{111 }
\DoxyCodeLine{112     \textcolor{comment}{//-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{113     \textcolor{comment}{// pagerank iterations}}
\DoxyCodeLine{114     \textcolor{comment}{//-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{115     \textcolor{keywordflow}{for} ((*iters) = 0 ; (*iters) < itermax; (*iters)++)}
\DoxyCodeLine{116     \{}
\DoxyCodeLine{117         \textcolor{keywordtype}{float} teleport = scaled\_damping ; \textcolor{comment}{// teleport = (1 -\/ damping) / n}}
\DoxyCodeLine{118         \textcolor{keywordflow}{if} (nsinks > 0)}
\DoxyCodeLine{119         \{}
\DoxyCodeLine{120             \textcolor{keyword}{const} \textcolor{keywordtype}{float} damping\_over\_n = damping / n ;}
\DoxyCodeLine{121             \textcolor{comment}{// handle the sinks: teleport += (damping/n) * sum (r (sink))}}
\DoxyCodeLine{122             \textcolor{comment}{// rsink<struct(sink)> = r}}
\DoxyCodeLine{123             GrB\_TRY (GrB\_Vector\_clear (rsink)) ;}
\DoxyCodeLine{124 }
\DoxyCodeLine{125             GrB\_TRY (GrB\_assign (rsink, sink, NULL, r, GrB\_ALL, n, GrB\_DESC\_S));}
\DoxyCodeLine{126 }
\DoxyCodeLine{127             \textcolor{comment}{// sum\_rsink = sum (rsink)}}
\DoxyCodeLine{128             \textcolor{keywordtype}{float} sum\_rsink = 0 ;}
\DoxyCodeLine{129             GrB\_TRY (GrB\_reduce (\&sum\_rsink, NULL, GrB\_PLUS\_MONOID\_FP32, rsink, NULL)) ;}
\DoxyCodeLine{130             teleport += damping\_over\_n * sum\_rsink ;}
\DoxyCodeLine{131         \}}
\DoxyCodeLine{132 }
\DoxyCodeLine{133         \textcolor{comment}{// swap t and r ; now t is the old score}}
\DoxyCodeLine{134         GrB\_Vector temp = t ; t = r ; r = temp ;}
\DoxyCodeLine{135         \textcolor{comment}{// w = t ./ d}}
\DoxyCodeLine{136 }
\DoxyCodeLine{137         GrB\_TRY (GrB\_eWiseMult (w, MASK\_NULL, NULL, GrB\_DIV\_FP32, t, d, NULL)) ;}
\DoxyCodeLine{138 }
\DoxyCodeLine{139         \textcolor{comment}{// r = teleport}}
\DoxyCodeLine{140         GrB\_TRY (GrB\_assign (r, MASK\_NULL, NULL, teleport, GrB\_ALL, n, NULL)) ;}
\DoxyCodeLine{141 }
\DoxyCodeLine{142         \textcolor{comment}{// r += A'*w}}
\DoxyCodeLine{143         SAVE\_STATS((GrB\_TRY (GrB\_mxv (r, MASK\_NULL, GrB\_PLUS\_FP32, LAGraph\_plus\_second\_fp32, AT, w, \&desc))),}
\DoxyCodeLine{144                    \textcolor{stringliteral}{"{}pr\_mxv"{}}, (\textcolor{keyword}{sizeof}(\textcolor{keywordtype}{float})*2 + \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{size\_t})), 1, AT);}
\DoxyCodeLine{145 }
\DoxyCodeLine{146         \textcolor{comment}{// t -\/= r}}
\DoxyCodeLine{147         GrB\_TRY (GrB\_assign (t, MASK\_NULL, GrB\_MINUS\_FP32, r, GrB\_ALL, n, NULL)) ;}
\DoxyCodeLine{148         \textcolor{comment}{// t = abs (t)}}
\DoxyCodeLine{149         GrB\_TRY (GrB\_apply (t, MASK\_NULL, NULL, GrB\_ABS\_FP32, t, NULL)) ;}
\DoxyCodeLine{150         \textcolor{comment}{// rdiff = sum (t)}}
\DoxyCodeLine{151         GrB\_TRY (GrB\_reduce (\&rdiff, NULL, GrB\_PLUS\_MONOID\_FP32, t, NULL)) ;}
\DoxyCodeLine{152 }
\DoxyCodeLine{153         \textcolor{comment}{//float ranks\_sum = 0;}}
\DoxyCodeLine{154         \textcolor{keywordtype}{double} ranks\_sum = 0;}
\DoxyCodeLine{155         GrB\_TRY (GrB\_reduce (\&ranks\_sum, NULL, GrB\_PLUS\_MONOID\_FP32, r, NULL));}
\DoxyCodeLine{156 \textcolor{preprocessor}{        \#ifdef \_\_DEBUG\_INFO\_\_}}
\DoxyCodeLine{157         cout << \textcolor{stringliteral}{"{}ranks sum: "{}} << ranks\_sum << endl;}
\DoxyCodeLine{158 \textcolor{preprocessor}{        \#endif}}
\DoxyCodeLine{159     \}}
\DoxyCodeLine{160 }
\DoxyCodeLine{161     \textcolor{comment}{//-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{162     \textcolor{comment}{// free workspace and return result}}
\DoxyCodeLine{163     \textcolor{comment}{//-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/-\/}}
\DoxyCodeLine{164 }
\DoxyCodeLine{165     centrality-\/>dup(r);}
\DoxyCodeLine{166     GrB\_free (\&d1) ;}
\DoxyCodeLine{167     GrB\_free (\&d);}
\DoxyCodeLine{168     GrB\_free (\&t);}
\DoxyCodeLine{169     GrB\_free (\&w);}
\DoxyCodeLine{170     GrB\_free (\&r);}
\DoxyCodeLine{171     \textcolor{keywordflow}{if} (nsinks > 0)}
\DoxyCodeLine{172     \{}
\DoxyCodeLine{173         GrB\_free (\&sink);}
\DoxyCodeLine{174         GrB\_free (\&rsink);}
\DoxyCodeLine{175     \}}
\DoxyCodeLine{176 \}}
\DoxyCodeLine{177 }
\DoxyCodeLine{179 }
\DoxyCodeLine{180 \textcolor{preprocessor}{\#undef GrB\_Matrix}}
\DoxyCodeLine{181 \textcolor{preprocessor}{\#undef GrB\_Vector}}
\DoxyCodeLine{182 \textcolor{preprocessor}{\#undef MASK\_NULL}}
\DoxyCodeLine{183 }
\DoxyCodeLine{185 }
\DoxyCodeLine{186 \textcolor{comment}{// Алгоритм преобразования LAGraph кода графового алгоритма к коду, совместимому с GB\_Kun}}
\DoxyCodeLine{187 \textcolor{comment}{// удалить инициализуию LAgraph}}
\DoxyCodeLine{188 \textcolor{comment}{// lablas::Vector<Index>* d\_out}}
\DoxyCodeLine{189 \textcolor{comment}{// *}}
\DoxyCodeLine{190 \textcolor{comment}{// изменить маски NULL на MASK\_TEMP}}
\DoxyCodeLine{191 \textcolor{comment}{// изменить дескриптор}}

\end{DoxyCode}
